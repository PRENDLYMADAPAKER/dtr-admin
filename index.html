<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Admin Panel - Clinician DTR</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
  body {
    font-family: Inter, system-ui, Arial, sans-serif;
    background: linear-gradient(135deg, #ffffff, #ff9ce3, #a855f7);
    color: #2c0a34;
    display: flex;
    justify-content: center;
    padding: 20px;
    min-height: 100vh;
  }

  .card {
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    padding: 20px;
    border-radius: 16px;
    width: 100%;
    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    margin-bottom: 20px;
  }

  h1, h2 {
    margin-top: 0;
    color: #2c0a34;
  }

  button {
    padding: 6px 12px;
    border-radius: 8px;
    border: none;
    background: linear-gradient(135deg, #ffffff, #ff9ce3, #a855f7);
    color: #2c0a34;
    font-weight: 600;
    cursor: pointer;
    transition: 0.3s ease;
  }
  button:hover {
    opacity: 0.9;
    transform: scale(1.03);
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 12px;
  }
  th, td {
    padding: 8px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    font-size: 14px;
    text-align: center;
  }

  .row { display: flex; gap: 8px; }
  .muted { font-size: 13px; opacity: 0.8; }
  .error { color: #b91c1c; }
  .success { color: #166534; }

  /* Dashboard layout */
  #dashboard {
    display: flex;
    flex-direction: column;
    gap: 20px;
    width: 100%;
    max-width: 1300px;
  }
  .dashboard-left { flex: 0 0 400px; }
  .dashboard-right { flex: 1; }

  #preview {
    width: 100%;
    max-width: 380px;
    border-radius: 8px;
    background: #000;
  }

  @media (min-width: 1024px) {
    #dashboard {
      flex-direction: row;
      align-items: flex-start;
    }
  }

  @media (max-width: 768px) {
    .row { flex-direction: column; }
    table { display: block; overflow-x: auto; white-space: nowrap; }
    button { width: 100%; }
  }

  /* Modal */
  .modal {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 200;
  }
  .modal .modal-content {
    background: rgba(255,255,255,0.95);
    padding: 20px;
    border-radius: 12px;
    max-width: 800px;
    width: 100%;
    max-height: 90vh;
    overflow: auto;
  }
  .modal .closeBtn {
    float: right;
    background: #ef4444;
    color: white;
    border: none;
    padding: 6px 10px;
    border-radius: 6px;
    cursor: pointer;
  }
  .tabs { margin: 10px 0; display:flex; gap:10px; }
  </style>
</head>
<body>
  <div id="dashboard">
    <!-- Left side: Scanner -->
    <div class="dashboard-left">
      <div class="card">
        <h2>QR Scanner</h2>
        <div class="row" style="margin-bottom:10px">
          <button onclick="startScanner()">Start Scanner</button>
          <button onclick="stopScanner()" style="background:#ef4444;color:white;">Stop Scanner</button>
        </div>
        <video id="preview"></video>
        <p id="scanStatus" class="muted"></p>
      </div>
    </div>

    <!-- Right side -->
    <div class="dashboard-right">
      <!-- Panel header -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h1>Admin Panel - Clinician DTR</h1>
          <div class="row">
            <button id="openRequests">‚öôÔ∏è Update Requests</button>
            <button id="openBasket">üóÇ Basket</button>
          </div>
        </div>
      </div>

      <!-- Last Scan Result -->
      <div class="card" id="scanResult" style="display:none;">
        <h3>Last Scan Result</h3>
        <p><strong>Name:</strong> <span id="resName">-</span></p>
        <p><strong>Clinical Level:</strong> <span id="resLevel">-</span></p>
        <p><strong>Email:</strong> <span id="resEmail">-</span></p>
        <p><strong>Time In:</strong> <span id="resTime">-</span></p>
      </div>

      <!-- Attendance Logs -->
      <div class="card" id="logsSection">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2>Attendance Logs (Today)</h2>
          <div class="row">
            <button onclick="exportLogs()">Export</button>
            <button onclick="printLogs()">Print</button>
            <button onclick="resetLogs()">Clear Logs View</button>
            <button onclick="deleteToday()" style="background:#ef4444;color:white;">Delete Today‚Äôs Records</button>
          </div>
        </div>
        <table>
          <thead><tr><th>User</th><th>Date</th><th>Time In</th></tr></thead>
          <tbody id="logsBody"><tr><td colspan="3" class="muted">No logs today</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Requests Modal -->
  <div id="requestsModal" class="modal">
    <div class="modal-content">
      <button class="closeBtn" id="closeRequests">‚úñ</button>
      <h2>Update Requests</h2>
      <label class="muted">Filter: 
        <select id="filterSelect">
          <option value="all">All</option>
          <option value="pending">Pending</option>
          <option value="approved">Approved</option>
          <option value="rejected">Rejected</option>
        </select>
      </label>
      <table>
        <thead><tr><th>User</th><th>Field</th><th>Requested Value</th><th>Current Value</th><th>Status</th><th>Actions</th></tr></thead>
        <tbody id="requestsBody"><tr><td colspan="6" class="muted">No requests yet</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- Basket Modal -->
  <div id="basketModal" class="modal">
    <div class="modal-content">
      <button class="closeBtn" id="closeBasket">‚úñ</button>
      <h2>Basket (Archived Requests)</h2>
      <div class="tabs">
        <button onclick="showBasket('approved')">‚úÖ Approved</button>
        <button onclick="showBasket('rejected')">‚ùå Rejected</button>
      </div>
      <table>
        <thead><tr><th>User</th><th>Field</th><th>Requested</th><th>Current</th><th>Status</th><th>Date</th></tr></thead>
        <tbody id="basketBody"><tr><td colspan="6" class="muted">Select Approved or Rejected</td></tr></tbody>
      </table>
    </div>
  </div>
  <!-- libs -->
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBYYZrsZECXM2UpW4-38sGQLaPqAqkjSWI",
      authDomain: "dtr-project-66048.firebaseapp.com",
      databaseURL: "https://dtr-project-66048-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "dtr-project-66048",
      storageBucket: "dtr-project-66048.appspot.com",
      messagingSenderId: "271445506225",
      appId: "1:271445506225:web:fcb04d0454e1302de14a90",
      measurementId: "G-R22CLKSPCP"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // === Success Sound ===
    function playSound(id) {
      try {
        const a = document.getElementById(id);
        if (a) a.play().catch(()=>{});
      } catch(e){ console.warn('sound error', e); }
    }

    // === Scanner ===
    const codeReader = new ZXing.BrowserQRCodeReader();
    const preview = document.getElementById('preview');
    const scanStatus = document.getElementById('scanStatus');

    async function startScanner() {
      try {
        const devices = await codeReader.listVideoInputDevices();
        if (devices.length > 0) {
          const back = devices.find(d => /back|rear|environment/i.test(d.label)) || devices[0];
          codeReader.decodeFromVideoDevice(back.deviceId, preview, (result, err) => {
            if (result && result.getText) handleScan(result.getText());
          });
          scanStatus.textContent = "Scanner started. Point camera at QR code.";
          scanStatus.className = "muted";
        } else {
          scanStatus.textContent = "No camera devices found.";
          scanStatus.className = "error";
        }
      } catch (err) {
        scanStatus.textContent = "Camera error: " + err.message;
        scanStatus.className = "error";
      }
    }

    function stopScanner() {
      try { codeReader.reset(); } catch(e){}
      preview.srcObject = null;
      scanStatus.textContent = "Scanner stopped.";
      scanStatus.className = "muted";
    }

    async function handleScan(uid) {
      const now = new Date();
      const dateStr = now.toISOString().split('T')[0];
      const timeStr = now.toTimeString().split(' ')[0];
      const dtrRef = db.ref('users/' + uid + '/dtr/' + dateStr);
      const snapshot = await dtrRef.once('value');

      if (snapshot.exists() && snapshot.val().timeIn) {
        const existingTime = snapshot.val().timeIn;
        const profileSnap = await db.ref('users/' + uid + '/profile').once('value');
        const profile = profileSnap.val() || {};
        document.getElementById('resName').textContent = profile.name || uid;
        document.getElementById('resLevel').textContent = profile.clinicalLevel || '-';
        document.getElementById('resEmail').textContent = profile.email || '-';
        document.getElementById('resTime').textContent = existingTime;
        document.getElementById('scanResult').style.display = 'block';
        scanStatus.textContent = (profile.name || uid) + " already Time-In today at " + existingTime;
        scanStatus.className = "error";
        return;
      }

      await dtrRef.set({ timeIn: timeStr });
      const profileSnap = await db.ref('users/' + uid + '/profile').once('value');
      const profile = profileSnap.val() || {};
      document.getElementById('resName').textContent = profile.name || uid;
      document.getElementById('resLevel').textContent = profile.clinicalLevel || '-';
      document.getElementById('resEmail').textContent = profile.email || '-';
      document.getElementById('resTime').textContent = timeStr;
      document.getElementById('scanResult').style.display = 'block';
      scanStatus.textContent = "Recorded for " + (profile.name || uid) + " at " + timeStr;
      scanStatus.className = "success";
      playSound('success-sound');
    }

    // === Attendance Logs ===
    const logsBody = document.getElementById('logsBody');
    let todayLogs = [];
    db.ref('users').on('value', snap => {
      logsBody.innerHTML = '';
      todayLogs = [];
      const today = new Date().toISOString().split('T')[0];
      let hasLogs = false;
      snap.forEach(userSnap => {
        const profile = userSnap.child('profile').val();
        const name = profile?.name || userSnap.key;
        const dtr = userSnap.child('dtr').val() || {};
        if (dtr[today]) {
          hasLogs = true;
          const timeIn = dtr[today].timeIn;
          todayLogs.push({ name, date: today, timeIn });
          logsBody.innerHTML += `<tr><td>${name}</td><td>${today}</td><td>${timeIn}</td></tr>`;
        }
      });
      if (!hasLogs) logsBody.innerHTML = '<tr><td colspan="3" class="muted">No logs today</td></tr>';
    });

    function exportLogs() {
      if (todayLogs.length === 0) return alert("No logs to export.");
      let csv = "Name,Date,Time In\n";
      todayLogs.forEach(l => { csv += `${l.name},${l.date},${l.timeIn}\n`; });
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a"); a.href = url; a.download = "attendance_logs_today.csv"; a.click();
      URL.revokeObjectURL(url);
    }

    function printLogs() {
      if (todayLogs.length === 0) {
        alert("No logs to print.");
        return;
      }

      let rowsPerPage = 40; // adjust per page
      let pages = [];

      for (let i = 0; i < todayLogs.length; i += rowsPerPage) {
        let chunk = todayLogs.slice(i, i + rowsPerPage);
        pages.push(`
          <table>
            <thead>
              <tr><th>User</th><th>Date</th><th>Time In</th></tr>
            </thead>
            <tbody>
              ${chunk.map(l => `
                <tr>
                  <td>${l.name}</td>
                  <td>${l.date}</td>
                  <td>${l.timeIn}</td>
                </tr>`).join('')}
            </tbody>
          </table>
        `);
      }

      let html = `
        <html>
        <head>
          <title>Attendance Logs (Today)</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 20px; }
            h2 { text-align: center; margin-bottom: 20px; }
            table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
            th, td { border: 1px solid #333; padding: 8px 12px; text-align: center; font-size: 14px; }
            th { background: #f3f3f3; }
            tr:nth-child(even) { background: #fafafa; }
            .page-break { page-break-after: always; }
          </style>
        </head>
        <body>
          <h2>Attendance Logs (Today)</h2>
          ${pages.map((p, i) => `<div class="page-break">${p}</div>`).join('')}
        </body>
        </html>
      `;

      let win = window.open("", "_blank");
      win.document.write(html);
      win.document.close();
      win.print();
    }

    function resetLogs() {
      // Soft reset - clears only admin logs view
      todayLogs = [];
      logsBody.innerHTML = '<tr><td colspan="3" class="muted">No logs today</td></tr>';
    }

    function deleteToday() {
      // Hard reset - wipes Time In records from Firebase
      if (!confirm("‚ö†Ô∏è WARNING: This will permanently delete today‚Äôs Time In records for ALL users. Continue?")) return;
      const today = new Date().toISOString().split('T')[0];
      db.ref('users').once('value').then(snap => {
        snap.forEach(userSnap => {
          db.ref(`users/${userSnap.key}/dtr/${today}`).remove();
        });
        alert("‚úÖ Today‚Äôs records have been deleted.");
      });
    }

    // === Requests Modal ===
    const requestsModal=document.getElementById('requestsModal');
    document.getElementById('openRequests').onclick=()=>{requestsModal.style.display='flex';};
    document.getElementById('closeRequests').onclick=()=>{requestsModal.style.display='none';};
    window.onclick=e=>{
      if(e.target===requestsModal) requestsModal.style.display='none';
      if(e.target===basketModal) basketModal.style.display='none';
    };

    const requestsBody=document.getElementById('requestsBody');
    const filterSelect=document.getElementById('filterSelect');

    function renderRequests(snap,filter){
      requestsBody.innerHTML='';
      if(!snap.exists()){ requestsBody.innerHTML='<tr><td colspan="6" class="muted">No requests yet</td></tr>'; return;}
      let has=false;
      snap.forEach(userSnap=>{
        const uid=userSnap.key;
        userSnap.forEach(reqSnap=>{
          const req=reqSnap.val(), reqId=reqSnap.key;
          if(filter!=="all" && req.status!==filter) return;
          has=true;
          db.ref('users/'+uid+'/profile').once('value').then(profileSnap=>{
            const profile=profileSnap.val()||{};
            const currentVal=req.field==="password"?"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢":(profile[req.field]||"");
            const row=document.createElement('tr');
            row.innerHTML=`
              <td>${profile.name||uid}<br><span class="muted">${profile.email||''}</span></td>
              <td>${req.field}</td>
              <td>${req.value}</td>
              <td>${currentVal}</td>
              <td>${req.status}</td>
              <td>
                <button onclick="approveReq('${uid}','${reqId}','${req.field}','${req.value}')">Approve</button>
                <button onclick="rejectReq('${uid}','${reqId}')">Reject</button>
              </td>`;
            requestsBody.appendChild(row);
          });
        });
      });
      if(!has) requestsBody.innerHTML='<tr><td colspan="6" class="muted">No matching requests</td></tr>';
    }

    db.ref('updateRequests').on('value',snap=>renderRequests(snap,filterSelect.value));
    filterSelect.onchange=()=>db.ref('updateRequests').once('value').then(snap=>renderRequests(snap,filterSelect.value));

    async function approveReq(uid,reqId,field,value){
      if(field!=="password") await db.ref('users/'+uid+'/profile/'+field).set(value);
      const [reqSnap, profileSnap] = await Promise.all([
        db.ref('updateRequests/'+uid+'/'+reqId).once('value'),
        db.ref('users/'+uid+'/profile').once('value')
      ]);
      const reqData=reqSnap.val()||{};
      const profile=profileSnap.val()||{};
      await db.ref('basket/approved/'+reqId).set({
        ...reqData,
        uid,
        name: profile.name || uid,
        email: profile.email || '',
        status:'approved',
        ts:Date.now()
      });
      await db.ref('updateRequests/'+uid+'/'+reqId).remove();
      playSound('success-sound');
    }

    async function rejectReq(uid,reqId){
      const [reqSnap, profileSnap] = await Promise.all([
        db.ref('updateRequests/'+uid+'/'+reqId).once('value'),
        db.ref('users/'+uid+'/profile').once('value')
      ]);
      const reqData=reqSnap.val()||{};
      const profile=profileSnap.val()||{};
      await db.ref('basket/rejected/'+reqId).set({
        ...reqData,
        uid,
        name: profile.name || uid,
        email: profile.email || '',
        status:'rejected',
        ts:Date.now()
      });
      await db.ref('updateRequests/'+uid+'/'+reqId).remove();
    }

    // === Basket Modal ===
    const basketModal=document.getElementById('basketModal');
    const openBasket=document.getElementById('openBasket');
    const closeBasket=document.getElementById('closeBasket');
    const basketBody=document.getElementById('basketBody');
    let basketData={approved:{},rejected:{}};

    openBasket.onclick=()=>{basketModal.style.display='flex';};
    closeBasket.onclick=()=>{basketModal.style.display='none';};

    function renderBasket(type){
      const data=basketData[type]||{};
      if(!Object.keys(data).length){ 
        basketBody.innerHTML=`<tr><td colspan="6" class="muted">No ${type} requests</td></tr>`; 
        return; 
      }
      basketBody.innerHTML=Object.entries(data).map(([id,r])=>`
        <tr>
          <td>${r.name||'-'}<br><span class="muted">${r.email||''}</span></td>
          <td>${r.field||''}</td>
          <td>${r.value||''}</td>
          <td>${r.currentValue||''}</td>
          <td>${r.status||''}</td>
          <td>${new Date(r.ts).toLocaleString()}</td>
        </tr>`).join('');
    }
    function showBasket(type){ renderBasket(type); }
    db.ref('basket/approved').on('value',snap=>{basketData.approved=snap.exists()?snap.val():{};});
    db.ref('basket/rejected').on('value',snap=>{basketData.rejected=snap.exists()?snap.val():{};});
  </script>

  <audio id="success-sound" src="Thank you.mp3" preload="auto"></audio>
</body>
</html>
