<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin DTR Panel â€” QR Scanner with Firebase</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #121212;
      color: #eee;
      margin: 0; padding: 0; text-align: center;
    }
    header {
      padding: 15px;
      background: #1e1e1e;
      font-size: 20px;
      font-weight: bold;
    }
    #video {
      width: 320px;
      max-width: 90vw;
      margin: 20px auto;
      border-radius: 8px;
      box-shadow: 0 0 10px #00f;
    }
    #result {
      margin-top: 15px;
      font-size: 18px;
      font-weight: bold;
      min-height: 24px;
    }
    table {
      width: 90%;
      margin: 20px auto;
      border-collapse: collapse;
      color: #eee;
    }
    th, td {
      border: 1px solid #444;
      padding: 8px;
      text-align: center;
    }
    th {
      background: #333;
    }
    tr:nth-child(even) {
      background: #1e1e1e;
    }
  </style>
</head>
<body>
  <header>ðŸ“‹ Admin DTR Panel â€” ZXing QR Scanner + Firebase</header>

  <video id="video" muted autoplay playsinline></video>
  <div id="result">Initializing camera...</div>

  <h2>Today's Logs</h2>
  <table aria-live="polite" id="logs-table">
    <thead>
      <tr><th>User ID</th><th>Time In</th></tr>
    </thead>
    <tbody id="logs-body">
      <tr><td colspan="2">Loading...</td></tr>
    </tbody>
  </table>

  <!-- ZXing library -->
  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/umd/index.min.js"></script>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, get, set, child, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // Your Firebase config here:
    const firebaseConfig = {
      apiKey: "AIzaSyBYYZrsZECXM2UpW4-38sGQLaPqAqkjSWI",
      authDomain: "dtr-project-66048.firebaseapp.com",
      databaseURL: "https://dtr-project-66048-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "dtr-project-66048",
      storageBucket: "dtr-project-66048.appspot.com",
      messagingSenderId: "271445506225",
      appId: "1:271445506225:web:fcb04d0454e1302de14a90",
      measurementId: "G-R22CLKSPCP"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ZXing Setup
    const codeReader = new ZXing.BrowserQRCodeReader();
    const videoElement = document.getElementById('video');
    const resultDiv = document.getElementById('result');
    let scanning = false;

    // Format today's date YYYY-MM-DD
    function todayYMD() {
      const d = new Date();
      const pad = n => n < 10 ? '0' + n : n;
      return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
    }

    // Get current time HH:MM:SS
    function timeHMS() {
      const d = new Date();
      const pad = n => n < 10 ? '0' + n : n;
      return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    // Start the camera and scanner
    async function startScanner() {
      try {
        const devices = await codeReader.listVideoInputDevices();
        if (devices.length === 0) {
          resultDiv.textContent = "âŒ No camera devices found.";
          return;
        }
        // Prefer environment (rear) camera if available
        const backCamera = devices.find(device => device.label.toLowerCase().includes('back')) || devices[0];
        scanning = true;
        resultDiv.textContent = "ðŸ“· Point the camera to a QR code.";
        await codeReader.decodeFromVideoDevice(backCamera.deviceId, videoElement, (result, err) => {
          if (result) {
            handleScan(result.getText());
          }
          if (err && !(err instanceof ZXing.NotFoundException)) {
            console.error(err);
          }
        });
      } catch (error) {
        resultDiv.textContent = "Camera error: " + error.message;
        console.error("Camera error:", error);
      }
    }

    // Simple debounce so it won't flood with multiple scans of same QR quickly
    const scanCooldowns = {};
    async function handleScan(text) {
      if (!scanning) return;
      const uid = text.trim();
      if (!uid) return;

      const now = Date.now();
      if (scanCooldowns[uid] && now - scanCooldowns[uid] < 5000) {
        // Ignore duplicate scans within 5 seconds
        return;
      }
      scanCooldowns[uid] = now;

      resultDiv.textContent = `â³ Processing UID: ${uid} ...`;

      const dateStr = todayYMD();
      const timeStr = timeHMS();

      try {
        const userRef = ref(db, `users/${uid}/profile`);
        const userSnap = await get(userRef);
        if (!userSnap.exists()) {
          resultDiv.textContent = `âŒ UID ${uid} not registered.`;
          return;
        }
        const profile = userSnap.val();

        const dtrRef = ref(db, `users/${uid}/dtr/${dateStr}`);
        const dtrSnap = await get(dtrRef);
        if (dtrSnap.exists()) {
          resultDiv.textContent = `âš ï¸ User ${profile.name} already timed in today at ${dtrSnap.val().timeIn}`;
          return;
        }

        // Write DTR record
        await set(dtrRef, { timeIn: timeStr, ts: Date.now() });
        await set(ref(db, `timeIns/${dateStr}/${uid}`), { uid, name: profile.name, email: profile.email || '-', date: dateStr, time: timeStr, ts: Date.now() });

        resultDiv.textContent = `âœ… Recorded time-in for ${profile.name} at ${timeStr}`;
      } catch (err) {
        console.error("Error saving DTR:", err);
        resultDiv.textContent = "âŒ Error saving time-in: " + err.message;
      }
    }

    // Load today's logs live and display them
    function listenLogs() {
      const logsBody = document.getElementById('logs-body');
      const dateStr = todayYMD();
      const logsRef = ref(db, `timeIns/${dateStr}`);

      onValue(logsRef, (snapshot) => {
        const logs = snapshot.val() || {};
        const entries = Object.values(logs).sort((a,b) => (b.ts||0) - (a.ts||0));

        if (entries.length === 0) {
          logsBody.innerHTML = '<tr><td colspan="2">No records today</td></tr>';
          return;
        }

        logsBody.innerHTML = entries.map(entry =>
          `<tr><td>${entry.uid}</td><td>${entry.time}</td></tr>`
        ).join('');
      });
    }

    window.onload = () => {
      startScanner();
      listenLogs();
    };
  </script>
</body>
</html>
