<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Clinician Admin Panel</title>
  <style>
    :root {
      --bg: #0b1220;
      --panel: #0f1724;
      --muted: #94a3b8;
      --accent: #06b6d4;
      --success: #4ade80;
      --warn: #fbbf24;
      --danger: #ef4444;
    }
    html,body{height:100%;margin:0;font-family:Inter,Arial,sans-serif;background:var(--bg);color:#e6eef8}
    header{background:var(--panel);padding:12px 20px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 1px 0 rgba(255,255,255,0.02)}
    header h1{margin:0;font-size:18px}
    #clock{font-family:monospace;color:var(--muted)}
    main{max-width:1100px;margin:20px auto;padding:0 16px;display:grid;grid-template-columns:1fr 1fr;gap:18px;box-sizing:border-box}
    .card{background:#0f1724;padding:18px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.6)}
    /* scanner */
    #video{width:100%;max-width:360px;border-radius:8px;background:#000;display:block;margin:0 auto}
    #result{margin-top:12px;text-align:center;font-weight:600;min-height:28px}
    #profile {margin-top:12px;background:#0b1220;padding:10px;border-radius:8px;display:none}
    #profile div{margin:6px 0}
    .controls{display:flex;gap:10px;justify-content:center;margin-top:14px}
    button{background:linear-gradient(90deg,var(--accent),#60a5fa);color:#021124;border:none;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:700}
    button[disabled]{opacity:.6;cursor:not-allowed}
    /* logs */
    #logs-controls{display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
    #logs-search{flex:1;min-width:180px;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
    .action-btn{background:#3b82f6;color:white;padding:8px 10px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
    .reset-btn{background:var(--danger);color:white}
    table{width:100%;border-collapse:collapse;margin-top:6px;font-size:14px}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.04);text-align:left}
    th{background:rgba(255,255,255,0.02);cursor:pointer;position:relative}
    th .sort-arrow{position:absolute;right:8px;top:50%;transform:translateY(-50%);color:var(--muted)}
    tr:nth-child(even){background:rgba(255,255,255,0.01)}
    .no-records{text-align:center;color:var(--muted);padding:18px}
    /* clinical small */
    .clinical { font-size:0.85em; opacity:0.9; color:#dbeafe }
    /* responsive */
    @media (max-width:900px){
      main{grid-template-columns:1fr; padding:12px}
      #video{max-width:280px}
    }
  </style>

  <!-- ZXing UMD (global ZXing) -->
  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/umd/index.min.js"></script>
</head>
<body>
  <header>
    <h1>üìã Admin DTR Panel ‚Äî Clinician</h1>
    <div id="clock">--:--:--</div>
  </header>

  <main>
    <!-- Scanner / Profile column -->
    <section class="card" id="scanner-card">
      <video id="video" muted autoplay playsinline></video>
      <div id="result">Scanner idle</div>

      <div id="profile" aria-live="polite">
        <div><strong>Name:</strong> <span id="profile-name"></span></div>
        <div><strong>Email:</strong> <span id="profile-email"></span></div>
        <div><strong>Clinical Level:</strong> <span id="profile-clinical" class="clinical"></span></div>
      </div>

      <div class="controls">
        <button id="start-btn">Start Scanner</button>
        <button id="stop-btn" disabled>Stop Scanner</button>
      </div>
    </section>

    <!-- Logs column -->
    <section class="card" id="logs-card">
      <div id="logs-controls">
        <input id="logs-search" placeholder="Search name/email/clinical..." />
        <button id="export-btn" class="action-btn">üíæ Export</button>
        <button id="print-btn" class="action-btn">üñ®Ô∏è Print</button>
        <button id="reset-btn" class="action-btn reset-btn">üîÑ Reset Today</button>
      </div>

      <table id="logs-table" aria-live="polite">
        <thead>
          <tr>
            <th data-key="name">Name <span class="sort-arrow"></span></th>
            <th data-key="email">Email <span class="sort-arrow"></span></th>
            <th data-key="clinicalLevel">Clinical Level <span class="sort-arrow"></span></th>
            <th data-key="ts">Time In <span class="sort-arrow"></span></th>
          </tr>
        </thead>
        <tbody id="logs-body">
          <tr><td colspan="4" class="no-records">Loading...</td></tr>
        </tbody>
      </table>
    </section>
  </main>
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, onValue, get, set, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  // ---------- Firebase config (your project) ----------
  const firebaseConfig = {
    apiKey: "AIzaSyBYYZrsZECXM2UpW4-38sGQLaPqAqkjSWI",
    authDomain: "dtr-project-66048.firebaseapp.com",
    databaseURL: "https://dtr-project-66048-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "dtr-project-66048",
    storageBucket: "dtr-project-66048.appspot.com",
    messagingSenderId: "271445506225",
    appId: "1:271445506225:web:fcb04d0454e1302de14a90",
    measurementId: "G-R22CLKSPCP"
  };
  // ----------------------------------------------------

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // DOM refs
  const videoEl = document.getElementById('video');
  const resultDiv = document.getElementById('result');
  const profileBox = document.getElementById('profile');
  const profileName = document.getElementById('profile-name');
  const profileEmail = document.getElementById('profile-email');
  const profileClinical = document.getElementById('profile-clinical');

  const startBtn = document.getElementById('start-btn');
  const stopBtn = document.getElementById('stop-btn');
  const exportBtn = document.getElementById('export-btn');
  const printBtn = document.getElementById('print-btn');
  const resetBtn = document.getElementById('reset-btn');

  const logsSearch = document.getElementById('logs-search');
  const logsBody = document.getElementById('logs-body');
  const clockElem = document.getElementById('clock');

  // ZXing reader (global ZXing from UMD script)
  const codeReader = new ZXing.BrowserQRCodeReader();

  // State
  let scanning = false;
  let scanCooldowns = {};
  let logsData = []; // live timeIns entries for today
  let currentSort = { key: 'ts', ascending: false };

  // Helpers
  function pad(n){ return n < 10 ? '0' + n : n; }
  function todayYMD(d = new Date()){
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }
  function timeHMS(d = new Date()){
    return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }
  function escapeHtml(s){ if(s==null) return ''; return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  // Clock
  function updateClock(){
    const now = new Date();
    clockElem.textContent = `${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
  }
  setInterval(updateClock, 1000); updateClock();

  // Status
  function setResult(msg, status='info'){
    const icons = { success:'‚úÖ', error:'‚ùå', warning:'‚ö†Ô∏è', info:'‚ÑπÔ∏è' };
    resultDiv.textContent = `${icons[status]||''} ${msg}`;
    resultDiv.className = '';
    resultDiv.classList.add(`status-${status}`);
  }

  // Start / Stop scanner
  async function startScanner(){
    if (scanning) return;
    try {
      const devices = await codeReader.listVideoInputDevices();
      if (!devices || devices.length === 0) {
        setResult('No camera devices found.', 'error');
        return;
      }
      const back = devices.find(d => /back|rear|environment/i.test(d.label)) || devices[0];
      scanning = true;
      setResult('Point camera to a QR code.', 'info');

      await codeReader.decodeFromVideoDevice(back.deviceId, videoEl, (result, err) => {
        if (result && result.getText) handleScan(result.getText());
        else if (err && !(err instanceof ZXing.NotFoundException)) {
          console.error(err);
          setResult('Camera error: ' + err.message, 'error');
        }
      });
      startBtn.disabled = true; stopBtn.disabled = false;
    } catch(e){
      console.error('startScanner', e);
      setResult('Camera error: ' + (e.message || e), 'error');
    }
  }
  function stopScanner(){
    try { codeReader.reset(); } catch(e){ /* ignore */ }
    scanning = false;
    setResult('Scanner stopped.', 'info');
    startBtn.disabled = false; stopBtn.disabled = true;
    profileBox.style.display = 'none';
  }

  // Handle scan with debounce and DB writes
  async function handleScan(text){
    if (!scanning) return;
    const uid = String(text || '').trim();
    if (!uid) return;
    const now = Date.now();
    if (scanCooldowns[uid] && (now - scanCooldowns[uid] < 4000)) return; // 4 sec cooldown
    scanCooldowns[uid] = now;

    setResult(`Processing UID: ${uid} ...`, 'info');
    profileBox.style.display = 'none';

    const dateStr = todayYMD();
    const timeStr = timeHMS();

    try {
      // get profile
      const profSnap = await get(ref(db, `users/${uid}/profile`));
      if (!profSnap.exists()){
        setResult(`UID ${uid} not registered.`, 'error');
        return;
      }
      const profile = profSnap.val();
      const clinical = profile.clinicalLevel || '';

      // check existing dtr
      const dtrSnap = await get(ref(db, `users/${uid}/dtr/${dateStr}`));
      if (dtrSnap.exists()){
        setResult(`User ${profile.name} already timed in today at ${dtrSnap.val().timeIn}`, 'warning');
        showProfile(profile.name, profile.email, clinical);
        addToHistory(profile.name, profile.email || '-', clinical, dateStr, dtrSnap.val().timeIn, false);
        return;
      }

      // write per-user DTR and write timeIns record
      await set(ref(db, `users/${uid}/dtr/${dateStr}`), { timeIn: timeStr, date: dateStr, ts: Date.now() });
      await set(ref(db, `timeIns/${dateStr}/${uid}`), {
        uid,
        name: profile.name || '',
        email: profile.email || '',
        clinicalLevel: clinical,
        date: dateStr,
        time: timeStr,
        ts: Date.now()
      });

      setResult(`Recorded time-in for ${profile.name} at ${timeStr}`, 'success');
      showProfile(profile.name, profile.email, clinical);
      addToHistory(profile.name, profile.email || '-', clinical, dateStr, timeStr, true);
      document.getElementById('success-sound').play();
    } catch(err){
      console.error('Error saving DTR:', err);
      setResult('Error saving time-in: ' + (err.message || err), 'error');
      profileBox.style.display = 'none';
    }
  }

  function showProfile(name, email, clinical){
    profileName.textContent = name || '-';
    profileEmail.textContent = email || '-';
    profileClinical.textContent = clinical || '-';
    profileBox.style.display = 'block';
  }

  // Local scan history (in-memory)
  let scanHistory = [];
  function addToHistory(name, email, clinical, date, time, success){
    scanHistory.unshift({ name, email, clinical, date, time, success, ts: Date.now() });
    renderHistory();
  }
  function renderHistory(filter=''){
    // (we show this in console or keep history panel later)
    // For now it's only stored; you could render to a panel if desired.
  }

  // Listen to today's timeIns and render logs
  function listenLogs(){
    const dateStr = todayYMD();
    const logsRef = ref(db, `timeIns/${dateStr}`);
    onValue(logsRef, snapshot => {
      const val = snapshot.val() || {};
      logsData = Object.values(val).map(e => ({
        uid: e.uid || '',
        name: e.name || '',
        email: e.email || '',
        clinicalLevel: e.clinicalLevel || '',
        date: e.date || dateStr,
        time: e.time || '',
        ts: e.ts || 0
      }));
      sortLogs(currentSort.key, currentSort.ascending);
      renderLogs(logsSearch.value || '');
    });
  }

  function renderLogs(filterText=''){
    const ft = (filterText || '').toLowerCase();
    const filtered = logsData.filter(e =>
      e.name.toLowerCase().includes(ft) ||
      e.email.toLowerCase().includes(ft) ||
      (e.clinicalLevel || '').toString().toLowerCase().includes(ft) ||
      (e.date || '').toLowerCase().includes(ft) ||
      (e.time || '').toLowerCase().includes(ft)
    );
    if (filtered.length === 0){
      logsBody.innerHTML = '<tr><td colspan="4" class="no-records">No records</td></tr>';
      return;
    }
    logsBody.innerHTML = filtered.map(entry => {
      const timeWithDate = `${escapeHtml(entry.time)} ‚Äî ${escapeHtml(entry.date)}`;
      return `<tr>
        <td>${escapeHtml(entry.name)}</td>
        <td>${escapeHtml(entry.email)}</td>
        <td class="clinical">${escapeHtml(entry.clinicalLevel || '')}</td>
        <td>${timeWithDate}</td>
      </tr>`;
    }).join('');
  }

  // Sorting
  function sortLogs(key, ascending){
    currentSort = { key, ascending };
    logsData.sort((a,b) => {
      let va = a[key] == null ? '' : a[key].toString().toLowerCase();
      let vb = b[key] == null ? '' : b[key].toString().toLowerCase();
      if (key === 'ts') { // numeric compare
        const na = a.ts || 0, nb = b.ts || 0;
        return ascending ? na - nb : nb - na;
      } else if (key === 'clinicalLevel'){
        const na = parseInt(va,10), nb = parseInt(vb,10);
        if (!isNaN(na) && !isNaN(nb)) return ascending ? na - nb : nb - na;
      }
      if (va < vb) return ascending ? -1 : 1;
      if (va > vb) return ascending ? 1 : -1;
      return 0;
    });
  }

  // Table header click sorting wiring
  document.querySelectorAll('#logs-table th').forEach(th => {
    th.addEventListener('click', () => {
      const key = th.getAttribute('data-key') || 'ts';
      if (currentSort.key === key) currentSort.ascending = !currentSort.ascending;
      else currentSort = { key, ascending: true };
      sortLogs(currentSort.key, currentSort.ascending);
      renderLogs(logsSearch.value || '');
      updateSortArrows();
    });
  });

  function updateSortArrows(){
    document.querySelectorAll('#logs-table th').forEach(th => {
      const span = th.querySelector('.sort-arrow');
      if (!span) return;
      const key = th.getAttribute('data-key');
      if (key === currentSort.key) span.textContent = currentSort.ascending ? '‚ñ≤' : '‚ñº';
      else span.textContent = '';
    });
  }

  // Search
  logsSearch.addEventListener('input', () => renderLogs(logsSearch.value || ''));

  // Export CSV
  function exportCSV(){
    if (!logsData || logsData.length === 0) { alert('No data to export'); return; }
    const headers = ['Name','Email','Clinical Level','Time In'];
    const rows = logsData.map(r => [`${r.name}`, `${r.email}`, `${r.clinicalLevel||''}`, `${r.time} ‚Äî ${r.date}`]);
    let csv = headers.join(',') + '\r\n';
    rows.forEach(cols => {
      csv += cols.map(c => `"${String(c||'').replace(/"/g,'""')}"`).join(',') + '\r\n';
    });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `dtr_logs_${todayYMD()}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
  }
  exportBtn.addEventListener('click', exportCSV);

  // Print logs
  function printLogs(){
    const html = `<html><head><title>DTR Logs ${todayYMD()}</title>
      <style>body{font-family:Arial;color:#111}table{width:100%;border-collapse:collapse}th,td{border:1px solid #ccc;padding:6px;text-align:left}th{background:#eee}</style>
      </head><body><h2>DTR Logs ${todayYMD()}</h2><table><thead><tr><th>Name</th><th>Email</th><th>Clinical Level</th><th>Time In</th></tr></thead><tbody>` +
      logsData.map(r => `<tr><td>${escapeHtml(r.name)}</td><td>${escapeHtml(r.email)}</td><td>${escapeHtml(r.clinicalLevel)}</td><td>${escapeHtml(r.time)} ‚Äî ${escapeHtml(r.date)}</td></tr>`).join('') +
      `</tbody></table></body></html>`;
    const w = window.open('', '_blank', 'width=900,height=700'); w.document.write(html); w.document.close(); w.focus(); w.print();
  }
  printBtn.addEventListener('click', printLogs);

  // Reset (archive & clear)
  async function resetToday(){
    if (!confirm('Archive today\'s logs to /archives/{date} and clear live results?')) return;
    const dateStr = todayYMD();
    const liveRef = ref(db, `timeIns/${dateStr}`);
    const archiveRef = ref(db, `archives/${dateStr}`);
    try {
      const snap = await get(liveRef);
      if (!snap.exists()) { alert('No logs to archive for today.'); return; }
      const data = snap.val();
      await set(archiveRef, data);    // archive
      await remove(liveRef);         // clear live logs
      // NOTE: per-user users/{uid}/dtr entries are kept (recommended). If you want to clear those too, we can add that.
      setResult('Archived and cleared today\'s logs.', 'success');
    } catch(err){
      console.error('resetToday', err);
      setResult('Failed to reset: ' + (err.message || err), 'error');
    }
  }
  resetBtn.addEventListener('click', resetToday);

  // Auto midnight archive (runs in browser only when page open) ‚Äî fallback only
  function scheduleMidnightArchive(){
    const now = new Date();
    const next = new Date(now.getFullYear(), now.getMonth(), now.getDate()+1, 0, 0, 10);
    const ms = next.getTime() - now.getTime();
    setTimeout(async () => {
      try {
        // archive yesterday (the day that just ended)
        const archiveDate = todayYMD(new Date(Date.now() - 86400000));
        const liveRef = ref(db, `timeIns/${archiveDate}`);
        const archiveRef = ref(db, `archives/${archiveDate}`);
        const snap = await get(liveRef);
        if (snap.exists()) {
          await set(archiveRef, snap.val());
          await remove(liveRef);
          console.info('Auto-archived', archiveDate);
        }
      } catch(e){ console.error('auto-archive error', e); }
      scheduleMidnightArchive();
    }, ms);
  }
  scheduleMidnightArchive(); // start

  // Initial listeners & auto-start off
  listenLogs();
  updateSortArrows();
  setResult('Ready. Click "Start Scanner".', 'info');

  // Wire start/stop buttons
  startBtn.addEventListener('click', startScanner);
  stopBtn.addEventListener('click', stopScanner);

  // Expose some helpers for debugging if needed
  window._admin = { startScanner, stopScanner, resetToday, exportCSV, printLogs };

</script>

  <audio id="success-sound" src="Thank you.mp3" preload="auto"></audio>
</body>
</html>
