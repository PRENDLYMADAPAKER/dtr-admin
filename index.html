<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>QR Scanner with Firebase - Working Example</title>
<style>
  body { font-family: Arial, sans-serif; background: #121212; color: #eee; margin: 0; padding: 20px; text-align: center; }
  #reader { width: 300px; margin: 0 auto; border-radius: 8px; overflow: hidden; }
  #status { margin-top: 10px; font-weight: bold; }
  #result { margin-top: 20px; background: #222; padding: 10px; border-radius: 8px; word-break: break-all; }
</style>
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>
<!-- Html5 Qrcode -->
<script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
</head>
<body>

<h1>QR Code Scanner</h1>
<div id="reader"></div>
<div id="status">Initializing camera...</div>
<div id="result">Scanned result will appear here.</div>

<script>
  // Initialize Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyBYYZrsZECXM2UpW4-38sGQLaPqAqkjSWI",
    authDomain: "dtr-project-66048.firebaseapp.com",
    databaseURL: "https://dtr-project-66048-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "dtr-project-66048",
    storageBucket: "dtr-project-66048.appspot.com",
    messagingSenderId: "271445506225",
    appId: "1:271445506225:web:fcb04d0454e1302de14a90",
    measurementId: "G-R22CLKSPCP"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Helper for date/time formatting
  function todayYMD() {
    const d = new Date();
    const pad = n => n < 10 ? '0' + n : n;
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }
  function timeHMS() {
    const d = new Date();
    const pad = n => n < 10 ? '0' + n : n;
    return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }

  // Show status
  function showStatus(msg, isError = false) {
    const el = document.getElementById('status');
    el.textContent = msg;
    el.style.color = isError ? '#ff6b6b' : '#9ca3af';
  }
  // Show result
  function showResult(text) {
    document.getElementById('result').textContent = `Scanned: ${text}`;
  }

  async function handleScan(scannedText) {
    const uid = scannedText.trim();
    if (!uid) return;
    showStatus("Processing scan...");
    showResult(uid);

    const date = todayYMD();
    const time = timeHMS();

    try {
      const userProfileSnap = await db.ref('users/' + uid + '/profile').get();
      if (!userProfileSnap.exists()) {
        showStatus("User not registered.", true);
        return;
      }
      const profile = userProfileSnap.val();
      const userDtrRef = db.ref(`users/${uid}/dtr/${date}`);
      const dtrSnap = await userDtrRef.get();
      if (dtrSnap.exists()) {
        showStatus("Already timed in today.");
        return;
      }
      const record = { uid, name: profile.name || 'Unknown', email: profile.email || '—', date, time, ts: Date.now() };
      await userDtrRef.set({ timeIn: time, ts: record.ts });
      await db.ref(`timeIns/${date}/${uid}`).set(record);
      showStatus("Time-In recorded ✔");
    } catch (err) {
      console.error(err);
      showStatus("Error: " + err.message, true);
    }
  }

  async function startScanner() {
    const readerId = "reader";
    const html5QrCode = new Html5Qrcode(readerId);

    try {
      const cameras = await Html5Qrcode.getCameras();
      if (!cameras || cameras.length === 0) {
        showStatus("No camera found.", true);
        return;
      }
      let cameraId = cameras[0].id;
      if (cameras.length > 1) {
        const backCam = cameras.find(c => /back|rear|environment/gi.test(c.label));
        if (backCam) cameraId = backCam.id;
        else cameraId = cameras[cameras.length - 1].id;
      }

      showStatus("Starting camera...");
      await html5QrCode.start(
        cameraId,
        { fps: 10, qrbox: 250 },
        (decodedText) => { handleScan(decodedText); },
        (errorMessage) => { /* ignore decode errors */ }
      );
      showStatus("Scanner active — point camera at QR code");
    } catch (err) {
      console.error("Camera error:", err);
      showStatus("Camera error: " + (err.message || err), true);
    }
  }

  startScanner();
</script>

</body>
</html>
