<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Clinician DTR - Admin Panel</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg1:#ffffff; --bg2:#ffd6ea; --bg3:#a855f7;
      --card-bg: rgba(255,255,255,0.55);
      --muted: rgba(0,0,0,0.45);
      --danger:#ef4444;
    }
    html,body{height:100%;margin:0;font-family:'Poppins',sans-serif;background:linear-gradient(135deg,var(--bg1),var(--bg2),var(--bg3));color:#1f1238}
    #app{width:100%;max-width:1300px;margin:18px auto;padding:0 12px;box-sizing:border-box}
    header{margin-bottom:18px}
    header h1{margin:0;font-weight:700}
    .card{background:var(--card-bg);border:1px solid rgba(255,255,255,0.6);border-radius:14px;padding:18px;margin-bottom:16px;box-shadow:0 8px 24px rgba(11,7,22,0.08)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button{padding:8px 12px;border-radius:10px;border:none;cursor:pointer;background:linear-gradient(135deg,#fff,#ffd6ea);font-weight:600;color:#2c0a34;box-shadow:0 6px 14px rgba(0,0,0,0.06)}
    button:hover{transform:translateY(-2px)}
    .danger{background:var(--danger);color:white}
    table{width:100%;border-collapse:collapse;margin-top:12px;background:transparent}
    th,td{padding:10px;border-bottom:1px solid rgba(0,0,0,0.06);font-size:14px}
    thead th{background:rgba(255,255,255,0.4);font-weight:600}
    .muted{color:var(--muted);font-size:13px}
    #dashboard{display:flex;gap:20px}
    .dashboard-left{flex:0 0 420px}
    .dashboard-right{flex:1}
    #preview{width:100%;height:260px;border-radius:10px;background:#000;object-fit:cover}
    .modal{position:fixed;inset:0;display:none;background:rgba(0,0,0,0.45);z-index:400;justify-content:center;align-items:center}
    .modal-content{width:95%;max-width:980px;max-height:90vh;overflow:auto;background:rgba(255,255,255,0.95);padding:18px;border-radius:12px;box-shadow:0 12px 32px rgba(0,0,0,0.12)}
    .closeBtn{float:right;background:var(--danger);color:white;padding:6px 10px;border:none;border-radius:8px;cursor:pointer}
    #wheelCanvas{display:block;margin:10px auto;border-radius:50%}
    @media (max-width:920px){#dashboard{flex-direction:column}.dashboard-left{width:100%}}

    /* Toasts */
    .toast {
      position: fixed; top: 18px; right: 18px;
      padding: 14px 18px; border-radius: 10px;
      font-weight: 700; color: #fff;
      z-index: 9999; box-shadow: 0 10px 30px rgba(0,0,0,0.18);
      transform: translateY(-6px); opacity: 0;
      transition: transform .25s ease, opacity .25s ease;
      pointer-events: none;
    }
    .toast.show{ transform: translateY(0); opacity: 1; pointer-events:auto; }
    .toast.success{ background: #16a34a; }
    .toast.error{ background: #dc2626; }
    .toast.warning{ background: #f59e0b; color:#1f1238; }

    /* inputs */
    input[type="text"], input[type="email"], select { padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);width:100%;box-sizing:border-box }
  </style>
</head>
<body>
  <div id="app">
    <header class="card">
      <h1>Clinical DTR â€” Admin Panel</h1>
      <p class="muted">Manage attendance, requests, and clinical cases</p>
    </header>

    <div id="dashboard">
      <div class="dashboard-left">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;margin-bottom:10px;">
            <div class="row">
              <button id="openRequests">Update Requests</button>
              <button id="openBasket">Basket</button>
              <button id="openCases">Case Management</button>
            </div>
            <h2 style="margin:0;">QR Scanner</h2>
          </div>

          <video id="preview" playsinline></video>

          <div class="row" style="margin-top:10px;">
            <button onclick="startScanner()">Start Scanner</button>
            <button class="danger" onclick="stopScanner()">Stop Scanner</button>
          </div>

          <p id="scanStatus" class="muted">Awaiting scan...</p>
        </div>

        <div class="card" id="scanResult" style="display:none;">
          <h3>Last Scan Result</h3>
          <p><b>Name:</b> <span id="resName">-</span></p>
          <p><b>Clinical Level:</b> <span id="resLevel">-</span></p>
          <p><b>Email:</b> <span id="resEmail">-</span></p>
          <p><b>Time In:</b> <span id="resTime">-</span></p>
        </div>
      </div>

      <div class="dashboard-right">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <h2>Attendance Logs (Today)</h2>
            <div class="row">
              <button onclick="exportLogs()">Export</button>
              <button onclick="printLogs()">Print</button>
              <button onclick="resetLogs()">Archive & Clear</button>
              <button class="danger" onclick="deleteToday()">Delete Today</button>
            </div>
          </div>
          <table>
            <thead><tr><th>User</th><th>Date</th><th>Time In</th></tr></thead>
            <tbody id="logsBody"><tr><td colspan="3" class="muted">No logs today</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Requests Modal -->
    <div id="requestsModal" class="modal">
      <div class="modal-content">
        <button class="closeBtn" id="closeRequests">âœ–</button>
        <h2>Update Requests</h2>
        <table>
          <thead><tr><th>User</th><th>Field</th><th>Requested</th><th>Current</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="requestsBody"><tr><td colspan="6" class="muted">No requests</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- Case Management Modal -->
    <div id="casesModal" class="modal">
      <div class="modal-content">
        <button class="closeBtn" id="closeCases">âœ–</button>
        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;">
          <h2 style="margin:0;">Case Management</h2>
          <div class="row" style="margin-top:8px;">
            <button onclick="exportCases()">Export CSV</button>
            <button onclick="printCases()">Print</button>
            <button onclick="openArchivedCases()">View History</button>
            <button onclick="loadDoneAssign()">View Done Assigned</button>
            <button class="danger" onclick="resetCases()">Archive & Clear</button>
          </div>
        </div>
        <input id="caseSearch" type="text" placeholder="Search pending cases..." style="margin:10px 0;width:100%;padding:8px;">
        <table>
          <thead><tr><th>User</th><th>Case Type</th><th>Details</th><th>Date</th><th>Instructor</th><th>Action</th></tr></thead>
          <tbody id="casesBody"><tr><td colspan="6" class="muted">No cases submitted yet</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- Done Assign Modal -->
    <div id="doneAssignModal" class="modal">
      <div class="modal-content">
        <button class="closeBtn" id="closeDoneAssign">âœ–</button>
        <h2>Done Assigned Cases</h2>
        <input id="doneSearch" type="text" placeholder="Search done assigned..." style="margin-bottom:10px;">
        <table>
          <thead><tr><th>User</th><th>Case</th><th>Instructor</th><th>Assigned At</th></tr></thead>
          <tbody id="doneAssignBody"><tr><td colspan="4" class="muted">No assigned cases yet</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- Archived Cases Modal -->
    <div id="archivedCasesModal" class="modal">
      <div class="modal-content">
        <button class="closeBtn" id="closeArchivedCases">âœ–</button>
        <h2>Archived Cases</h2>
        <div id="archivedCasesList"><p class="muted">Loading...</p></div>
      </div>
    </div>

    <!-- Spin Wheel Modal -->
    <div id="wheelModal" class="modal">
      <div class="modal-content" style="text-align:center;">
        <button class="closeBtn" id="closeWheel">âœ–</button>
        <h2>Spin Wheel â€” Assign Instructor</h2>
        <input id="instructorInput" type="text" placeholder="Dr. Cruz, Dr. Santos, ..." style="width:100%;padding:8px;margin-bottom:10px;">
        <canvas id="wheelCanvas" width="320" height="320"></canvas>
        <div class="row" style="justify-content:center;margin-top:10px;">
          <button onclick="spinWheel()">ðŸŽ¡ Spin</button>
          <span id="wheelResult" style="font-weight:600;margin-left:12px;"></span>
        </div>
      </div>
    </div>

    <div id="toastHolder"></div>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>

  <script>
  const firebaseConfig = {
    apiKey: "AIzaSyBYYZrsZECXM2UpW4-38sGQLaPqAqkjSWI",
    authDomain: "dtr-project-66048.firebaseapp.com",
    databaseURL: "https://dtr-project-66048-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "dtr-project-66048",
    storageBucket: "dtr-project-66048.appspot.com",
    messagingSenderId: "271445506225",
    appId: "1:271445506225:web:fcb04d0454e1302de14a90"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const $ = id => document.getElementById(id);
  function showToast(msg,type="success"){ const t=document.createElement("div");t.className=`toast ${type}`;t.innerText=msg;document.body.appendChild(t);requestAnimationFrame(()=>t.classList.add("show"));setTimeout(()=>{t.classList.remove("show");setTimeout(()=>t.remove(),300)},3500); }

  let codeReader=null;
  async function startScanner(){ if(codeReader){try{codeReader.reset()}catch(e){}}
    codeReader=new ZXing.BrowserQRCodeReader();
    const devices=await codeReader.listVideoInputDevices();
    if(!devices.length){showToast("No camera found","error");return}
    const device=devices.find(d=>/back|rear/i.test(d.label))||devices[0];
    codeReader.decodeFromVideoDevice(device.deviceId,$("preview"),(res,err)=>{if(res) handleScan(res.getText());});
    showToast("Scanner started","success"); }
  function stopScanner(){ if(codeReader) codeReader.reset(); showToast("Scanner stopped","warning"); }

  async function handleScan(uid){
    uid=uid.trim(); const today=new Date().toISOString().split("T")[0]; const timeStr=new Date().toTimeString().split(" ")[0];
    const prof=await db.ref(`users/${uid}/profile`).get(); if(!prof.exists()){showToast("Unknown UID","error");return}
    const profile=prof.val();
    const userRef=db.ref(`users/${uid}/dtr/${today}`); const snap=await userRef.get();
    if(snap.exists()&&snap.val().timeIn){showToast(`${profile.name||uid} already Time In today`,"warning");return}
    await userRef.set({timeIn:timeStr,ts:Date.now()});
    await db.ref(`adminLogs/${today}/${uid}`).set({name:profile.name||uid,email:profile.email||"",level:profile.clinicalLevel||"",timeIn:timeStr,ts:Date.now()});
    $("resName").innerText=profile.name||uid; $("resLevel").innerText=profile.clinicalLevel||"-"; $("resEmail").innerText=profile.email||"-"; $("resTime").innerText=timeStr; $("scanResult").style.display="block";
    showToast(`Time In recorded for ${profile.name||uid}`,"success"); loadTodayLogs();
  }

  async function loadTodayLogs(){const body=$("logsBody");body.innerHTML="";const today=new Date().toISOString().split("T")[0];const snap=await db.ref(`adminLogs/${today}`).get();
    if(!snap.exists()){body.innerHTML="<tr><td colspan=3 class=muted>No logs today</td></tr>";return}
    snap.forEach(u=>{const v=u.val();body.innerHTML+=`<tr><td>${v.name}</td><td>${today}</td><td>${v.timeIn}</td></tr>`})}

  async function resetLogs(){if(!confirm("Archive today's logs and clear?"))return;const today=new Date().toISOString().split("T")[0];const snap=await db.ref(`adminLogs/${today}`).get();if(!snap.exists()){showToast("No logs","warning");return}
    const updates={};snap.forEach(u=>updates[`archive/attendance/${today}/${u.key}`]=u.val());await db.ref().update(updates);await db.ref(`adminLogs/${today}`).remove();loadTodayLogs();showToast("Logs archived & cleared","success");}
  async function deleteToday(){if(!confirm("Delete today's records?"))return;const today=new Date().toISOString().split("T")[0];await db.ref(`adminLogs/${today}`).remove();showToast("Today's logs deleted","warning");loadTodayLogs();}
  </script>
  <script>
  /*********** CASE MANAGEMENT ***********/
  async function loadCases(){
    const body=$("casesBody");body.innerHTML="";
    const snap=await db.ref("cases").get();
    if(!snap.exists()){body.innerHTML="<tr><td colspan=6 class=muted>No cases</td></tr>";return}
    snap.forEach(u=>{
      u.forEach(c=>{
        const v=c.val();
        if(v.status!=="pending") return; // show only pending
        body.innerHTML+=`
          <tr>
            <td>${u.key}</td>
            <td>${v.type||""}</td>
            <td>${(v.details||"").replace(/\n/g," ")}</td>
            <td>${v.timestamp?new Date(v.timestamp).toLocaleString():"-"}</td>
            <td>${v.instructor||"Pending"}</td>
            <td><button onclick="assignInstructorByInput('${u.key}','${c.key}')">Assign</button></td>
          </tr>`;
      });
    });
  }

  async function assignInstructorByInput(uid,cid){
    const name=prompt("Instructor name:");
    if(!name) return;
    const c=await db.ref(`cases/${uid}/${cid}`).get();
    if(!c.exists()) return showToast("Case not found","error");
    await db.ref(`doneAssign/${uid}/${cid}`).set({...c.val(),instructor:name,status:"assigned",doneAt:Date.now()});
    await db.ref(`cases/${uid}/${cid}`).remove();
    showToast("Instructor assigned & moved","success");
    loadCases(); loadDoneAssign();
  }

  /*********** DONE ASSIGN ***********/
  async function loadDoneAssign(){
    const body=$("doneAssignBody");body.innerHTML="";
    const snap=await db.ref("doneAssign").get();
    if(!snap.exists()){body.innerHTML="<tr><td colspan=4 class=muted>No assigned cases</td></tr>";return}
    snap.forEach(u=>{
      u.forEach(c=>{
        const v=c.val();
        body.innerHTML+=`
          <tr>
            <td>${u.key}</td>
            <td>${v.type||""}</td>
            <td>${v.instructor||""}</td>
            <td>${v.doneAt?new Date(v.doneAt).toLocaleString():"-"}</td>
          </tr>`;
      });
    });
  }

  /*********** SEARCH FILTERS ***********/
  $("caseSearch").addEventListener("input",()=>{
    const term=$("caseSearch").value.toLowerCase();
    document.querySelectorAll("#casesBody tr").forEach(tr=>{
      const txt=tr.innerText.toLowerCase();
      tr.style.display=txt.includes(term)?"":"none";
    });
  });

  $("doneSearch").addEventListener("input",()=>{
    const term=$("doneSearch").value.toLowerCase();
    document.querySelectorAll("#doneAssignBody tr").forEach(tr=>{
      const txt=tr.innerText.toLowerCase();
      tr.style.display=txt.includes(term)?"":"none";
    });
  });

  /*********** REQUESTS ***********/
  async function loadRequests(){
    const body=$("requestsBody");body.innerHTML="";
    const snap=await db.ref("updateRequests").get();
    if(!snap.exists()){body.innerHTML="<tr><td colspan=6 class=muted>No requests</td></tr>";return}
    snap.forEach(u=>{
      u.forEach(r=>{
        const v=r.val();
        body.innerHTML+=`
          <tr>
            <td>${u.key}</td>
            <td>${v.field}</td>
            <td>${v.value}</td>
            <td>-</td>
            <td>${v.status||"pending"}</td>
            <td>
              <button onclick="approveReq('${u.key}','${r.key}','${v.field}','${encodeURIComponent(v.value)}')">Approve</button>
              <button onclick="rejectReq('${u.key}','${r.key}')">Reject</button>
            </td>
          </tr>`;
      });
    });
  }

  async function approveReq(uid,rid,field,valueEnc){
    const val=decodeURIComponent(valueEnc);
    if(["name","email","clinicalLevel"].includes(field)) await db.ref(`users/${uid}/profile/${field}`).set(val);
    await db.ref(`updateRequests/${uid}/${rid}`).remove();
    showToast("Request approved","success"); loadRequests();
  }
  async function rejectReq(uid,rid){
    await db.ref(`updateRequests/${uid}/${rid}`).remove();
    showToast("Request rejected","warning"); loadRequests();
  }

  /*********** MODAL CONTROLS ***********/
  $("openCases").onclick=()=>{ $("casesModal").style.display="flex"; loadCases(); };
  $("closeCases").onclick=()=> $("casesModal").style.display="none";

  $("loadDoneAssignBtn")?.onclick=()=>{ $("doneAssignModal").style.display="flex"; loadDoneAssign(); };
  $("closeDoneAssign").onclick=()=> $("doneAssignModal").style.display="none";

  $("openRequests").onclick=()=>{ $("requestsModal").style.display="flex"; loadRequests(); };
  $("closeRequests").onclick=()=> $("requestsModal").style.display="none";

  $("openArchivedCases")?.onclick=()=>{ $("archivedCasesModal").style.display="flex"; };
  $("closeArchivedCases").onclick=()=> $("archivedCasesModal").style.display="none";

  $("closeWheel").onclick=()=> $("wheelModal").style.display="none";

  window.onclick=e=>{
    if(e.target.classList.contains("modal")) e.target.style.display="none";
  };

  // init
  loadTodayLogs();
  </script>
</body>
</html>