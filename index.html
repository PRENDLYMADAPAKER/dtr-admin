<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Admin Attendance Panel</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; }
    .container { max-width: 900px; margin: auto; padding: 20px; }
    h1 { text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    table, th, td { border: 1px solid #ccc; }
    th, td { padding: 8px; text-align: center; }
    button { padding: 10px; margin: 10px 0; cursor: pointer; }
    #loginDiv, #adminDiv { background: white; padding: 20px; border-radius: 8px; }
    #adminDiv { display: none; }
  </style>
</head>
<body>
<div class="container">
  <div id="loginDiv">
    <h1>Admin Login</h1>
    <input type="email" id="email" placeholder="Email"><br><br>
    <input type="password" id="password" placeholder="Password"><br><br>
    <button onclick="adminLogin()">Login</button>
    <p id="loginError" style="color:red;"></p>
  </div>

  <div id="adminDiv">
    <h1>Attendance Admin Panel</h1>
    <button onclick="logout()">Logout</button>
    <h2>Scan QR to Time In</h2>
    <div id="reader" style="width:300px;"></div>
    <h2>Attendance Records</h2>
    <button onclick="window.print()">Print Records</button>
    <table id="attendanceTable">
      <thead>
        <tr>
          <th>Name</th>
          <th>UID</th>
          <th>Date</th>
          <th>Time</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyBYYZrsZECXM2UpW4-38sGQLaPqAqkjSWI",
    authDomain: "dtr-project-66048.firebaseapp.com",
    databaseURL: "https://dtr-project-66048-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "dtr-project-66048",
    storageBucket: "dtr-project-66048.firebasestorage.app",
    messagingSenderId: "271445506225",
    appId: "1:271445506225:web:fcb04d0454e1302de14a90",
    measurementId: "G-R22CLKSPCP"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  const allowedAdmins = ["admin@example.com"]; // Change to your admin emails

  function adminLogin() {
    const email = document.getElementById('email').value;
    const pass = document.getElementById('password').value;
    auth.signInWithEmailAndPassword(email, pass)
    .then(user => {
      if (!allowedAdmins.includes(email)) {
        auth.signOut();
        document.getElementById("loginError").innerText = "Not authorized as admin.";
        return;
      }
      document.getElementById('loginDiv').style.display = "none";
      document.getElementById('adminDiv').style.display = "block";
      loadAttendance();
      startQRScanner();
    })
    .catch(err => {
      document.getElementById("loginError").innerText = err.message;
    });
  }

  function logout() {
    auth.signOut().then(() => {
      document.getElementById('loginDiv').style.display = "block";
      document.getElementById('adminDiv').style.display = "none";
    });
  }

  function startQRScanner() {
    const html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      qrMessage => {
        recordTimeIn(qrMessage);
      },
      err => {}
    );
  }

  function recordTimeIn(userId) {
    const now = new Date();
    const date = now.toLocaleDateString();
    const time = now.toLocaleTimeString();

    db.ref("users/" + userId).once("value", snapshot => {
      if (snapshot.exists()) {
        const name = snapshot.val().name || "Unknown";
        const record = { name, uid: userId, date, time };
        db.ref("attendance/" + userId + "/" + now.getTime()).set(record);
        alert("Time In Recorded for " + name);
      } else {
        alert("User not found in database.");
      }
    });
  }

  function loadAttendance() {
    const tbody = document.querySelector("#attendanceTable tbody");
    db.ref("attendance").on("value", snapshot => {
      tbody.innerHTML = "";
      snapshot.forEach(userSnap => {
        userSnap.forEach(recordSnap => {
          const record = recordSnap.val();
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${record.name}</td>
            <td>${record.uid}</td>
            <td>${record.date}</td>
            <td>${record.time}</td>
          `;
          tbody.appendChild(tr);
        });
      });
    });
  }
</script>
</body>
  </html>
