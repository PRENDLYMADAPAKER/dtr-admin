<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Admin Panel - Clinician DTR</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
  body {
    font-family: Inter, system-ui, Arial, sans-serif;
    background: linear-gradient(135deg, #ffffff, #ff9ce3, #a855f7);
    color: #2c0a34;
    display: flex;
    justify-content: center;
    padding: 20px;
    min-height: 100vh;
  }

  .card {
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    padding: 20px;
    border-radius: 16px;
    max-width: 1200px;
    width: 100%;
    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
  }

  h1, h2 {
    margin-top: 0;
    color: #2c0a34;
  }

  button {
    padding: 6px 12px;
    border-radius: 8px;
    border: none;
    background: linear-gradient(135deg, #ffffff, #ff9ce3, #a855f7);
    color: #2c0a34;
    font-weight: 600;
    cursor: pointer;
    transition: 0.3s ease;
  }
  button:hover {
    opacity: 0.9;
    transform: scale(1.03);
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 12px;
  }
  th, td {
    padding: 8px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    font-size: 14px;
  }

  .row { display: flex; gap: 8px; }
  .muted { font-size: 13px; opacity: 0.8; }
  .error { color: #b91c1c; }
  .success { color: #166534; }

  /* Dashboard split layout */
  #dashboard {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }
  #preview {
    width: 100%;
    max-width: 380px;
    border-radius: 8px;
    background: #000;
  }
  @media (min-width: 1024px) {
    #dashboard {
      flex-direction: row;
      align-items: flex-start;
    }
    .dashboard-left {
      flex: 0 0 400px;
    }
    .dashboard-right {
      flex: 1;
    }
  }
  @media (max-width: 768px) {
    .row { flex-direction: column; }
    table { display: block; overflow-x: auto; white-space: nowrap; }
    button { width: 100%; }
  }

  /* Settings modal */
  #requestsModal {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 200;
  }
  #requestsModal .modal-content {
    background: rgba(255,255,255,0.95);
    padding: 20px;
    border-radius: 12px;
    max-width: 800px;
    width: 100%;
  }
  #closeModal {
    float: right;
    background: #ef4444;
    color: white;
    border: none;
    padding: 6px 10px;
    border-radius: 6px;
    cursor: pointer;
  }
  </style>
</head>
<body>
  <div class="card" id="dashboard">
    <!-- Left: Scanner -->
    <div class="dashboard-left">
      <section id="scannerSection">
        <h2>QR Scanner</h2>
        <div class="row" style="margin-bottom:10px">
          <button onclick="startScanner()">Start Scanner</button>
          <button onclick="stopScanner()" style="background:#ef4444;color:white;">Stop Scanner</button>
        </div>
        <video id="preview"></video>
        <p id="scanStatus" class="muted"></p>
      </section>
    </div>

    <!-- Right: Results + Logs -->
    <div class="dashboard-right">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h1>Admin Panel - Clinician DTR</h1>
        <button id="openRequests">⚙️ Update Requests</button>
      </div>

      <div id="scanResult" class="card" style="margin-top:10px;display:none;">
        <h3>Last Scan Result</h3>
        <p><strong>Name:</strong> <span id="resName">-</span></p>
        <p><strong>Clinical Level:</strong> <span id="resLevel">-</span></p>
        <p><strong>Email:</strong> <span id="resEmail">-</span></p>
        <p><strong>Time In:</strong> <span id="resTime">-</span></p>
      </div>

      <section id="logsSection" style="margin-top:20px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2>Attendance Logs (Today)</h2>
          <div class="row">
            <button onclick="exportLogs()">Export</button>
            <button onclick="printLogs()">Print</button>
            <button onclick="resetLogs()" style="background:#ef4444;color:white;">Reset Today</button>
          </div>
        </div>
        <table>
          <thead><tr><th>User</th><th>Date</th><th>Time In</th></tr></thead>
          <tbody id="logsBody"><tr><td colspan="3" class="muted">No logs today</td></tr></tbody>
        </table>
      </section>
    </div>
  </div>

  <!-- Requests Modal -->
  <div id="requestsModal">
    <div class="modal-content">
      <button id="closeModal">✖</button>
      <h2>Update Requests</h2>
      <label class="muted">Filter: 
        <select id="filterSelect">
          <option value="all">All</option>
          <option value="pending">Pending</option>
          <option value="approved">Approved</option>
          <option value="rejected">Rejected</option>
        </select>
      </label>
      <table>
        <thead><tr><th>User</th><th>Field</th><th>Requested Value</th><th>Current Value</th><th>Status</th><th>Actions</th></tr></thead>
        <tbody id="requestsBody"><tr><td colspan="6" class="muted">No requests yet</td></tr></tbody>
      </table>
    </div>
  </div>
  <!-- libs -->
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBYYZrsZECXM2UpW4-38sGQLaPqAqkjSWI",
      authDomain: "dtr-project-66048.firebaseapp.com",
      databaseURL: "https://dtr-project-66048-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "dtr-project-66048",
      storageBucket: "dtr-project-66048.appspot.com",
      messagingSenderId: "271445506225",
      appId: "1:271445506225:web:fcb04d0454e1302de14a90",
      measurementId: "G-R22CLKSPCP"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // === Success Sound ===
    function playSound(id) {
      try {
        const a = document.getElementById(id);
        if (!a) return;
        a.play().catch(()=>{});
      } catch(e){ console.warn('playSound error', e); }
    }

    // === Scanner ===
    const codeReader = new ZXing.BrowserQRCodeReader();
    const preview = document.getElementById('preview');
    const scanStatus = document.getElementById('scanStatus');

    async function startScanner() {
      try {
        const devices = await codeReader.listVideoInputDevices();
        if (devices.length > 0) {
          const back = devices.find(d => /back|rear|environment/i.test(d.label)) || devices[0];
          codeReader.decodeFromVideoDevice(back.deviceId, preview, (result, err) => {
            if (result && result.getText) handleScan(result.getText());
          });
          scanStatus.textContent = "Scanner started. Point camera at QR code.";
          scanStatus.className = "muted";
        } else {
          scanStatus.textContent = "No camera devices found.";
          scanStatus.className = "error";
        }
      } catch (err) {
        scanStatus.textContent = "Camera error: " + err.message;
        scanStatus.className = "error";
      }
    }

    function stopScanner() {
      try { codeReader.reset(); } catch(e){}
      preview.srcObject = null;
      scanStatus.textContent = "Scanner stopped.";
      scanStatus.className = "muted";
    }

    async function handleScan(uid) {
      const now = new Date();
      const dateStr = now.toISOString().split('T')[0];
      const timeStr = now.toTimeString().split(' ')[0];
      const dtrRef = db.ref('users/' + uid + '/dtr/' + dateStr);
      const snapshot = await dtrRef.once('value');

      // Already has time-in today
      if (snapshot.exists() && snapshot.val().timeIn) {
        const existingTime = snapshot.val().timeIn;
        const profileSnap = await db.ref('users/' + uid + '/profile').once('value');
        const profile = profileSnap.val() || {};
        document.getElementById('resName').textContent = profile.name || uid;
        document.getElementById('resLevel').textContent = profile.clinicalLevel || '-';
        document.getElementById('resEmail').textContent = profile.email || '-';
        document.getElementById('resTime').textContent = existingTime;
        document.getElementById('scanResult').style.display = 'block';
        scanStatus.textContent = (profile.name || uid) + " already Time-In today at " + existingTime;
        scanStatus.className = "error";
        return;
      }

      // First time-in
      await dtrRef.set({ timeIn: timeStr });
      const profileSnap = await db.ref('users/' + uid + '/profile').once('value');
      const profile = profileSnap.val() || {};
      document.getElementById('resName').textContent = profile.name || uid;
      document.getElementById('resLevel').textContent = profile.clinicalLevel || '-';
      document.getElementById('resEmail').textContent = profile.email || '-';
      document.getElementById('resTime').textContent = timeStr;
      document.getElementById('scanResult').style.display = 'block';
      scanStatus.textContent = "Recorded for " + (profile.name || uid) + " at " + timeStr;
      scanStatus.className = "success";
      playSound('success-sound');
    }

    // === Attendance Logs (Today only) ===
    const logsBody = document.getElementById('logsBody');
    let todayLogs = [];
    db.ref('users').on('value', snap => {
      logsBody.innerHTML = '';
      todayLogs = [];
      const today = new Date().toISOString().split('T')[0];
      let hasLogs = false;
      snap.forEach(userSnap => {
        const profile = userSnap.child('profile').val();
        const name = profile?.name || userSnap.key;
        const dtr = userSnap.child('dtr').val() || {};
        if (dtr[today]) {
          hasLogs = true;
          const timeIn = dtr[today].timeIn;
          todayLogs.push({ name, date: today, timeIn });
          logsBody.innerHTML += `<tr><td>${name}</td><td>${today}</td><td>${timeIn}</td></tr>`;
        }
      });
      if (!hasLogs) logsBody.innerHTML = '<tr><td colspan="3" class="muted">No logs today</td></tr>';
    });

    function exportLogs() {
      if (todayLogs.length === 0) return alert("No logs to export.");
      let csv = "Name,Date,Time In\n";
      todayLogs.forEach(l => { csv += `${l.name},${l.date},${l.timeIn}\n`; });
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a"); a.href = url; a.download = "attendance_logs_today.csv"; a.click();
      URL.revokeObjectURL(url);
    }

    function printLogs() {
      let win = window.open("", "_blank");
      win.document.write("<h2>Attendance Logs (Today)</h2>");
      win.document.write("<table border='1' cellspacing='0' cellpadding='6'><tr><th>User</th><th>Date</th><th>Time In</th></tr>");
      todayLogs.forEach(l => { win.document.write(`<tr><td>${l.name}</td><td>${l.date}</td><td>${l.timeIn}</td></tr>`); });
      win.document.write("</table>");
      win.print(); win.close();
    }

    function resetLogs() {
      if (!confirm("Are you sure you want to clear today’s logs?")) return;
      const today = new Date().toISOString().split('T')[0];
      db.ref('users').once('value').then(snap => {
        snap.forEach(userSnap => { db.ref(`users/${userSnap.key}/dtr/${today}`).remove(); });
      });
    }

    // === Update Requests Modal ===
    const requestsBody = document.getElementById('requestsBody');
    const filterSelect = document.getElementById('filterSelect');
    const requestsModal = document.getElementById('requestsModal');
    document.getElementById('openRequests').onclick = () => { requestsModal.style.display = 'flex'; };
    document.getElementById('closeModal').onclick = () => { requestsModal.style.display = 'none'; };
    window.onclick = (e) => { if (e.target === requestsModal) requestsModal.style.display = 'none'; };

    function renderRequests(snapshot, filter) {
      requestsBody.innerHTML = '';
      if (!snapshot.exists()) { requestsBody.innerHTML = '<tr><td colspan="6" class="muted">No requests yet</td></tr>'; return; }
      let hasData = false;
      snapshot.forEach(userSnap => {
        const uid = userSnap.key;
        userSnap.forEach(reqSnap => {
          const req = reqSnap.val();
          const reqId = reqSnap.key;
          if (filter !== "all" && req.status !== filter) return;
          hasData = true;
          db.ref('users/' + uid + '/profile').once('value').then(profileSnap => {
            const profile = profileSnap.val() || {};
            const currentVal = req.field === "password" ? "••••••" : (profile[req.field] || "");
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${profile.name || uid}</td>
              <td>${req.field}</td>
              <td>${req.value}</td>
              <td>${currentVal}</td>
              <td>${req.status}</td>
              <td>
                <button onclick="approveReq('${uid}','${reqId}','${req.field}','${req.value}')">Approve</button>
                <button onclick="rejectReq('${uid}','${reqId}')">Reject</button>
              </td>
            `;
            requestsBody.appendChild(row);
          });
        });
      });
      if (!hasData) requestsBody.innerHTML = '<tr><td colspan="6" class="muted">No matching requests</td></tr>';
    }
    db.ref('updateRequests').on('value', snap => { renderRequests(snap, filterSelect.value); });
    filterSelect.onchange = () => { db.ref('updateRequests').once('value').then(snap => renderRequests(snap, filterSelect.value)); };

    async function approveReq(uid, reqId, field, value) {
      if (field !== "password") await db.ref('users/' + uid + '/profile/' + field).set(value);
      await db.ref('updateRequests/' + uid + '/' + reqId + '/status').set('approved');
      playSound('success-sound');
    }
    async function rejectReq(uid, reqId) {
      await db.ref('updateRequests/' + uid + '/' + reqId + '/status').set('rejected');
    }
  </script>

  <audio id="success-sound" src="Thank you.mp3" preload="auto"></audio>
</body>
</html>
